<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Whisper WebSocket Test Client</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 30px;
        }
        h1 {
            color: #333;
            margin-bottom: 30px;
            font-size: 24px;
        }
        .status {
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 20px;
            font-weight: 500;
        }
        .status.disconnected {
            background: #fee;
            color: #c33;
        }
        .status.connected {
            background: #efe;
            color: #3a3;
        }
        .section {
            margin-bottom: 30px;
        }
        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #555;
        }
        input[type="file"] {
            display: block;
            margin-bottom: 15px;
            padding: 10px;
            border: 2px dashed #ddd;
            border-radius: 4px;
            width: 100%;
            cursor: pointer;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            margin-right: 10px;
            transition: background 0.2s;
        }
        button:hover:not(:disabled) {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .record-btn {
            background: #dc3545;
        }
        .record-btn:hover:not(:disabled) {
            background: #c82333;
        }
        .record-btn.recording {
            background: #28a745;
        }
        .file-info {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 14px;
            color: #666;
        }
        .result {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 4px;
            min-height: 100px;
            margin-top: 15px;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 16px;
            line-height: 1.6;
        }
        .result.loading {
            color: #999;
            font-style: italic;
        }
        .result.error {
            background: #fee;
            color: #c33;
        }
        .result.success {
            background: #efe;
            color: #333;
        }
        .log {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            line-height: 1.4;
        }
        .log-entry {
            margin-bottom: 5px;
        }
        .log-time {
            color: #888;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¤ Whisper WebSocket Test Client</h1>
        
        <div id="status" class="status disconnected">
            âš ï¸ æ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“
        </div>

        <div class="section">
            <div class="section-title">1ï¸âƒ£ WebSocketæ¥ç¶š</div>
            <button id="connectBtn" onclick="connect()">æ¥ç¶š</button>
            <button id="disconnectBtn" onclick="disconnect()" disabled>åˆ‡æ–­</button>
        </div>

        <div class="section">
            <div class="section-title">2ï¸âƒ£ éŸ³å£°éŒ²éŸ³ï¼ˆãƒã‚¤ã‚¯ï¼‰</div>
            <button class="record-btn" id="recordBtn" onclick="toggleRecording()" disabled>
                ğŸ™ï¸ éŒ²éŸ³é–‹å§‹
            </button>
            <div id="recordInfo" class="file-info" style="display:none;"></div>
        </div>

        <div class="section">
            <div class="section-title">3ï¸âƒ£ PCMãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</div>
            <input type="file" id="fileInput" accept=".pcm,.raw,.f32" onchange="handleFileSelect()" disabled>
            <div id="fileInfo" class="file-info" style="display:none;"></div>
            <button id="uploadBtn" onclick="uploadFile()" disabled>ğŸ“¤ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
        </div>

        <div class="section">
            <div class="section-title">ğŸ“ æ–‡å­—èµ·ã“ã—çµæœ</div>
            <div id="result" class="result">çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™...</div>
        </div>

        <div class="section">
            <div class="section-title">ğŸ“‹ ãƒ­ã‚°</div>
            <div id="log" class="log"></div>
        </div>
    </div>

    <script>
        let ws = null;
        let selectedFile = null;
        let mediaRecorder = null;
        let audioChunks = [];
        let audioContext = null;

        function addLog(message) {
            const log = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `<span class="log-time">[${time}]</span> ${message}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }

        function updateStatus(connected) {
            const status = document.getElementById('status');
            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');
            const fileInput = document.getElementById('fileInput');
            const uploadBtn = document.getElementById('uploadBtn');
            const recordBtn = document.getElementById('recordBtn');

            if (connected) {
                status.className = 'status connected';
                status.textContent = 'âœ… æ¥ç¶šã•ã‚Œã¾ã—ãŸ';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                fileInput.disabled = false;
                recordBtn.disabled = false;
            } else {
                status.className = 'status disconnected';
                status.textContent = 'âš ï¸ æ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
                fileInput.disabled = true;
                uploadBtn.disabled = true;
                recordBtn.disabled = true;
            }
        }

        function connect() {
            addLog('WebSocketã«æ¥ç¶šä¸­...');
            ws = new WebSocket('ws://127.0.0.1:9000');

            ws.onopen = () => {
                addLog('âœ… WebSocketæ¥ç¶šæˆåŠŸ');
                updateStatus(true);
            };

            ws.onmessage = (event) => {
                addLog(`ğŸ“¨ å—ä¿¡: ${event.data}`);
                try {
                    const data = JSON.parse(event.data);
                    const result = document.getElementById('result');
                    
                    if (data.error) {
                        result.className = 'result error';
                        result.textContent = `âŒ ã‚¨ãƒ©ãƒ¼: ${data.error}`;
                    } else if (data.status === 'queued') {
                        result.className = 'result loading';
                        result.textContent = 'â³ å‡¦ç†ä¸­...';
                    } else if (data.transcription !== undefined) {
                        result.className = 'result success';
                        result.textContent = data.transcription || '(ç„¡éŸ³ã¾ãŸã¯èªè­˜ã§ãã¾ã›ã‚“ã§ã—ãŸ)';
                    }
                } catch (e) {
                    addLog(`âš ï¸ JSONè§£æã‚¨ãƒ©ãƒ¼: ${e.message}`);
                }
            };

            ws.onerror = (error) => {
                addLog(`âŒ ã‚¨ãƒ©ãƒ¼: ${error}`);
            };

            ws.onclose = () => {
                addLog('ğŸ”Œ WebSocketæ¥ç¶šãŒåˆ‡æ–­ã•ã‚Œã¾ã—ãŸ');
                updateStatus(false);
                ws = null;
            };
        }

        function disconnect() {
            if (ws) {
                ws.close();
                addLog('åˆ‡æ–­ã—ã¾ã—ãŸ');
            }
        }

        function handleFileSelect() {
            const fileInput = document.getElementById('fileInput');
            const fileInfo = document.getElementById('fileInfo');
            const uploadBtn = document.getElementById('uploadBtn');
            
            selectedFile = fileInput.files[0];
            if (selectedFile) {
                const sizeKB = (selectedFile.size / 1024).toFixed(2);
                const samples = selectedFile.size / 4; // f32 = 4 bytes
                const duration = (samples / 16000).toFixed(2);
                
                fileInfo.style.display = 'block';
                fileInfo.innerHTML = `
                    ğŸ“„ ãƒ•ã‚¡ã‚¤ãƒ«: ${selectedFile.name}<br>
                    ğŸ“Š ã‚µã‚¤ã‚º: ${sizeKB} KB (${samples.toLocaleString()} samples)<br>
                    â±ï¸ æ¨å®šæ™‚é–“: ${duration} ç§’ (16kHzæƒ³å®š)
                `;
                uploadBtn.disabled = false;
                addLog(`ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ: ${selectedFile.name} (${sizeKB} KB)`);
            }
        }

        async function uploadFile() {
            if (!selectedFile || !ws || ws.readyState !== WebSocket.OPEN) {
                addLog('âŒ ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ãªã„ã‹ã€æ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }

            addLog(`ğŸ“¤ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–‹å§‹: ${selectedFile.name}`);
            const arrayBuffer = await selectedFile.arrayBuffer();
            
            ws.send(arrayBuffer);
            addLog(`âœ… é€ä¿¡å®Œäº† (${arrayBuffer.byteLength} bytes)`);
            
            const result = document.getElementById('result');
            result.className = 'result loading';
            result.textContent = 'â³ æ–‡å­—èµ·ã“ã—å‡¦ç†ä¸­...';
        }

        async function toggleRecording() {
            const recordBtn = document.getElementById('recordBtn');
            const recordInfo = document.getElementById('recordInfo');

            if (!mediaRecorder || mediaRecorder.state === 'inactive') {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    audioContext = new AudioContext({ sampleRate: 16000 });
                    addLog('ğŸ¤ éŒ²éŸ³ã‚’é–‹å§‹ã—ã¾ã—ãŸ (16kHz)');
                    
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    
                    mediaRecorder.ondataavailable = (event) => {
                        audioChunks.push(event.data);
                    };
                    
                    mediaRecorder.onstop = async () => {
                        addLog('ğŸ›‘ éŒ²éŸ³ã‚’åœæ­¢ã—ã¾ã—ãŸ');
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        await processRecordedAudio(audioBlob);
                        stream.getTracks().forEach(track => track.stop());
                    };
                    
                    mediaRecorder.start();
                    recordBtn.textContent = 'â¹ï¸ éŒ²éŸ³åœæ­¢';
                    recordBtn.classList.add('recording');
                    recordInfo.style.display = 'block';
                    recordInfo.textContent = 'ğŸ”´ éŒ²éŸ³ä¸­...';
                    
                } catch (err) {
                    addLog(`âŒ ãƒã‚¤ã‚¯ã‚¢ã‚¯ã‚»ã‚¹ã‚¨ãƒ©ãƒ¼: ${err.message}`);
                }
            } else {
                mediaRecorder.stop();
                recordBtn.textContent = 'ğŸ™ï¸ éŒ²éŸ³é–‹å§‹';
                recordBtn.classList.remove('recording');
                recordInfo.style.display = 'none';
            }
        }

        async function processRecordedAudio(audioBlob) {
            try {
                addLog('ğŸ”„ éŸ³å£°ã‚’16kHz PCM f32ã«å¤‰æ›ä¸­...');
                
                const arrayBuffer = await audioBlob.arrayBuffer();
                const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                
                // Resample to 16kHz if needed
                let audioData;
                if (audioBuffer.sampleRate !== 16000) {
                    const offlineContext = new OfflineAudioContext(1, audioBuffer.duration * 16000, 16000);
                    const source = offlineContext.createBufferSource();
                    source.buffer = audioBuffer;
                    source.connect(offlineContext.destination);
                    source.start(0);
                    const resampledBuffer = await offlineContext.startRendering();
                    audioData = resampledBuffer.getChannelData(0);
                } else {
                    audioData = audioBuffer.getChannelData(0);
                }
                
                // Convert to f32 binary
                const pcmData = new Float32Array(audioData);
                const bytes = new Uint8Array(pcmData.buffer);
                
                addLog(`âœ… å¤‰æ›å®Œäº†: ${pcmData.length} samples (${audioBuffer.duration.toFixed(2)}ç§’)`);
                
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(bytes);
                    addLog(`ğŸ“¤ é€ä¿¡å®Œäº† (${bytes.byteLength} bytes)`);
                    
                    const result = document.getElementById('result');
                    result.className = 'result loading';
                    result.textContent = 'â³ æ–‡å­—èµ·ã“ã—å‡¦ç†ä¸­...';
                }
            } catch (err) {
                addLog(`âŒ éŸ³å£°å‡¦ç†ã‚¨ãƒ©ãƒ¼: ${err.message}`);
            }
        }

        // åˆæœŸåŒ–
        addLog('ãƒšãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
        addLog('æ¥ç¶šãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦WebSocketã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã—ã¦ãã ã•ã„');
    </script>
</body>
</html>
